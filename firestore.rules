rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if the user is the owner by email
    function isOwnerByEmail(resource) {
    	return request.auth.token.email == resource.data.reportedBy || request.auth.token.email == resource.data.user;
    }

    // Helper function to get the user's apartment
    function getUserApartment() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.apartment;
    }

    // Users Collection
    // - Users can read and update their own data.
    // - Admins can read and write to any user document.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isAdmin();
      allow create, delete: if isAdmin();
    }

    // Notices Collection
    // - Only admins can create, update, or delete notices.
    // - Any authenticated user can read notices.
    match /notices/{noticeId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    // Incidents Collection
    // - Authenticated users can create incidents.
    // - Any authenticated user can read incidents.
    // - Admins can read, update, and delete any incident.
    match /incidents/{incidentId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;
      allow update, delete: if isAdmin();
    }

    // Lost and Found Collection
    // - Any authenticated user can create and read items.
    // - The user who reported the item or an admin can update/delete it.
    match /lostAndFound/{itemId} {
      allow read, create: if request.auth != null;
      allow update, delete: if isOwnerByEmail(resource) || isAdmin();
    }

    // Packages Collection
    // - Only admins can create, update, or delete packages.
    // - Any authenticated user can read packages.
    match /packages/{packageId} {
      allow create, update, delete: if isAdmin();
      allow read: if request.auth != null;
    }

    // Reservations Collection
    // - Authenticated users can create reservations.
    // - Users can read all reservations (to check availability) but can only delete their own.
    // - Admins can delete any reservation.
    match /reservations/{reservationId} {
      allow create, read: if request.auth != null;
      allow delete: if isOwnerByEmail(resource) || isAdmin();
    }

    // Visitors Collection
    // - Authenticated users can create visitors for their own apartment.
    // - Any authenticated user can read visitors.
    // - Admins can read and delete any visitor entry.
    match /visitors/{visitorId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;
      allow delete: if isAdmin();
    }

    // Financials Collection
    // - Only admins can read and write.
    match /financials/{transactionId} {
      allow read, write: if isAdmin();
    }
  }
}
